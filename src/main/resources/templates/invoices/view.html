<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/main}">
<head>
    <title>Invoice Details</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-receipt me-2"></i>Invoice <span th:text="${invoice.invoiceNumber}"></span></h2>
            <div>
                <a th:href="@{/invoices}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Back to List
                </a>
                <a th:if="${invoice.status.name() == 'DRAFT'}"
                   th:href="@{/invoices/edit/{id}(id=${invoice.id})}" class="btn btn-primary">
                    <i class="bi bi-pencil me-1"></i>Edit
                </a>
                <button th:if="${invoice.status.name() == 'DRAFT'}" class="btn btn-success"
                        onclick="document.getElementById('sendForm').submit();">
                    <i class="bi bi-send me-1"></i>Send Invoice
                </button>
                <form th:if="${invoice.status.name() == 'DRAFT'}"
                      th:action="@{/invoices/send/{id}(id=${invoice.id})}"
                      method="post" id="sendForm" style="display:none;"></form>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Invoice Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="text-muted">Bill To:</h6>
                                <p class="mb-0"><strong th:text="${invoice.customer.name}"></strong></p>
                                <p th:if="${invoice.customer.address}" th:text="${invoice.customer.address}" class="mb-0"></p>
                                <p th:if="${invoice.customer.email}" class="mb-0">
                                    <i class="bi bi-envelope me-1"></i><span th:text="${invoice.customer.email}"></span>
                                </p>
                                <p th:if="${invoice.customer.phone}" class="mb-0">
                                    <i class="bi bi-telephone me-1"></i><span th:text="${invoice.customer.phone}"></span>
                                </p>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <p class="mb-1"><strong>Invoice Date:</strong> <span th:text="${#temporals.format(invoice.invoiceDate, 'yyyy-MM-dd')}"></span></p>
                                <p class="mb-1"><strong>Due Date:</strong> <span th:text="${invoice.dueDate != null} ? ${#temporals.format(invoice.dueDate, 'yyyy-MM-dd')} : 'N/A'"></span></p>
                                <p class="mb-1">
                                    <strong>Status:</strong>
                                    <span class="badge"
                                          th:classappend="${invoice.status.name() == 'DRAFT'} ? 'bg-secondary' :
                                                          (${invoice.status.name() == 'SENT'} ? 'bg-info' :
                                                          (${invoice.status.name() == 'PAID'} ? 'bg-success' :
                                                          (${invoice.status.name() == 'OVERDUE'} ? 'bg-danger' : 'bg-warning')))"
                                          th:text="${invoice.status.name()}">Status</span>
                                </p>
                            </div>
                        </div>

                        <table class="table">
                            <thead class="table-light">
                                <tr>
                                    <th>Description</th>
                                    <th class="text-center">Qty</th>
                                    <th class="text-end">Unit Price</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="item : ${invoice.items}">
                                    <td th:text="${item.description}">Item description</td>
                                    <td class="text-center" th:text="${item.quantity}">1</td>
                                    <td class="text-end" th:text="${#numbers.formatDecimal(item.unitPrice, 1, 2)}">0.00</td>
                                    <td class="text-end" th:text="${#numbers.formatDecimal(item.amount, 1, 2)}">0.00</td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" class="text-end"><strong>Subtotal:</strong></td>
                                    <td class="text-end" th:text="${#numbers.formatDecimal(invoice.subtotal, 1, 2)}">0.00</td>
                                </tr>
                                <tr th:if="${invoice.taxAmount != null and invoice.taxAmount > 0}">
                                    <td colspan="3" class="text-end"><strong>Tax:</strong></td>
                                    <td class="text-end" th:text="${#numbers.formatDecimal(invoice.taxAmount, 1, 2)}">0.00</td>
                                </tr>
                                <tr class="table-dark">
                                    <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                    <td class="text-end"><strong th:text="${#numbers.formatDecimal(invoice.totalAmount, 1, 2)}">0.00</strong></td>
                                </tr>
                            </tfoot>
                        </table>

                        <div th:if="${invoice.notes}" class="mt-4">
                            <h6>Notes:</h6>
                            <p th:text="${invoice.notes}" class="text-muted"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <!-- Actions Card -->
                <div class="card shadow mb-4" sec:authorize="hasAnyRole('ADMIN', 'ACCOUNTANT')">
                    <div class="card-header">
                        <h5 class="mb-0">Actions</h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${invoice.status.name() == 'SENT' or invoice.status.name() == 'OVERDUE'}">
                            <form th:action="@{/invoices/pay/{id}(id=${invoice.id})}" method="post">
                                <div class="mb-3">
                                    <label class="form-label">Payment Date</label>
                                    <input type="date" name="paymentDate" class="form-control"
                                           th:value="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}" required>
                                </div>
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="bi bi-check-lg me-1"></i>Mark as Paid
                                </button>
                            </form>
                        </div>

                        <div th:if="${invoice.status.name() != 'PAID' and invoice.status.name() != 'CANCELLED'}" class="mt-3">
                            <form th:action="@{/invoices/cancel/{id}(id=${invoice.id})}" method="post">
                                <button type="submit" class="btn btn-outline-danger w-100"
                                        onclick="return confirm('Are you sure you want to cancel this invoice?')">
                                    <i class="bi bi-x-circle me-1"></i>Cancel Invoice
                                </button>
                            </form>
                        </div>

                        <div th:if="${invoice.status.name() == 'PAID' or invoice.status.name() == 'CANCELLED'}"
                             class="text-center text-muted">
                            <p>No actions available</p>
                        </div>
                    </div>
                </div>

                <!-- Journal Entry Card -->
                <div th:if="${invoice.journalEntry != null}" class="card shadow">
                    <div class="card-header">
                        <h5 class="mb-0">Linked Journal Entry</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Entry #:</strong>
                            <a th:href="@{/journal/view/{id}(id=${invoice.journalEntry.id})}"
                               th:text="${invoice.journalEntry.entryNumber}"></a>
                        </p>
                        <p><strong>Date:</strong> <span th:text="${#temporals.format(invoice.journalEntry.entryDate, 'yyyy-MM-dd')}"></span></p>
                        <p class="mb-0"><strong>Status:</strong>
                            <span class="badge"
                                  th:classappend="${invoice.journalEntry.status.name() == 'POSTED'} ? 'bg-success' : 'bg-secondary'"
                                  th:text="${invoice.journalEntry.status.name()}"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>