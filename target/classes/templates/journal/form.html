<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title th:text="${journalEntry.id != null} ? 'Edit Journal Entry' : 'New Journal Entry'">Journal Entry Form</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="card shadow">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="bi bi-pencil-square me-2"></i>
                    <span th:text="${journalEntry.id != null} ? 'Edit Journal Entry' : 'New Journal Entry'">Form</span>
                </h4>
            </div>
            <div class="card-body">
                <form th:action="@{/journal/save}" th:object="${journalEntry}" method="post" id="journalForm">
                    <input type="hidden" th:field="*{id}">

                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="entryNumber" class="form-label">Entry Number</label>
                            <input type="text" class="form-control" id="entryNumber" th:field="*{entryNumber}"
                                   readonly placeholder="Auto-generated">
                        </div>
                        <div class="col-md-3">
                            <label for="entryDate" class="form-label">Entry Date *</label>
                            <input type="date" class="form-control" id="entryDate" th:field="*{entryDate}" required>
                        </div>
                        <div class="col-md-6">
                            <label for="reference" class="form-label">Reference</label>
                            <input type="text" class="form-control" id="reference" th:field="*{reference}"
                                   placeholder="e.g., Invoice #, Check #">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description *</label>
                        <input type="text" class="form-control" id="description" th:field="*{description}"
                               required placeholder="Description of this journal entry">
                    </div>

                    <!-- Journal Entry Lines -->
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-list-ul me-2"></i>Entry Lines</span>
                            <button type="button" class="btn btn-sm btn-success" onclick="addLine()">
                                <i class="bi bi-plus-circle me-1"></i>Add Line
                            </button>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm" id="linesTable">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 35%">Account</th>
                                        <th style="width: 25%">Description</th>
                                        <th style="width: 15%" class="text-end">Debit</th>
                                        <th style="width: 15%" class="text-end">Credit</th>
                                        <th style="width: 10%"></th>
                                    </tr>
                                </thead>
                                <tbody id="linesBody">
                                    <tr th:each="line, iterStat : *{lines}" class="line-row">
                                        <td>
                                            <input type="hidden" th:name="|lines[${iterStat.index}].id|" th:value="${line.id}">
                                            <select th:name="|lines[${iterStat.index}].accountId|" class="form-select form-select-sm account-select" required>
                                                <option value="">Select Account</option>
                                                <option th:each="account : ${accounts}"
                                                        th:value="${account.id}"
                                                        th:text="${account.fullName}"
                                                        th:selected="${line.accountId == account.id}">Account</option>
                                            </select>
                                        </td>
                                        <td>
                                            <input type="text" th:name="|lines[${iterStat.index}].description|"
                                                   th:value="${line.description}"
                                                   class="form-control form-control-sm" placeholder="Line description">
                                        </td>
                                        <td>
                                            <input type="number" step="0.01" min="0"
                                                   th:name="|lines[${iterStat.index}].debitAmount|"
                                                   th:value="${line.debitAmount}"
                                                   class="form-control form-control-sm text-end debit-input"
                                                   placeholder="0.00" onchange="updateTotals()">
                                        </td>
                                        <td>
                                            <input type="number" step="0.01" min="0"
                                                   th:name="|lines[${iterStat.index}].creditAmount|"
                                                   th:value="${line.creditAmount}"
                                                   class="form-control form-control-sm text-end credit-input"
                                                   placeholder="0.00" onchange="updateTotals()">
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeLine(this)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="2" class="text-end"><strong>Totals:</strong></td>
                                        <td class="text-end"><strong id="totalDebit">0.00</strong></td>
                                        <td class="text-end"><strong id="totalCredit">0.00</strong></td>
                                        <td></td>
                                    </tr>
                                    <tr id="balanceRow">
                                        <td colspan="2" class="text-end">Difference:</td>
                                        <td colspan="2" class="text-center"><span id="difference" class="badge bg-success">0.00 (Balanced)</span></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a th:href="@{/journal}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left me-1"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary" id="saveBtn">
                            <i class="bi bi-check-circle me-1"></i>Save Entry
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div layout:fragment="scripts">
        <script th:inline="javascript">
            let lineIndex = [[${journalEntry.lines.size()}]];
            const accounts = [[${accounts}]];

            function addLine() {
                const tbody = document.getElementById('linesBody');
                const row = document.createElement('tr');
                row.className = 'line-row';

                let accountOptions = '<option value="">Select Account</option>';
                accounts.forEach(account => {
                    accountOptions += `<option value="${account.id}">${account.code} - ${account.name}</option>`;
                });

                row.innerHTML = `
                    <td>
                        <select name="lines[${lineIndex}].accountId" class="form-select form-select-sm account-select" required>
                            ${accountOptions}
                        </select>
                    </td>
                    <td>
                        <input type="text" name="lines[${lineIndex}].description" class="form-control form-control-sm" placeholder="Line description">
                    </td>
                    <td>
                        <input type="number" step="0.01" min="0" name="lines[${lineIndex}].debitAmount" class="form-control form-control-sm text-end debit-input" placeholder="0.00" onchange="updateTotals()">
                    </td>
                    <td>
                        <input type="number" step="0.01" min="0" name="lines[${lineIndex}].creditAmount" class="form-control form-control-sm text-end credit-input" placeholder="0.00" onchange="updateTotals()">
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeLine(this)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;

                tbody.appendChild(row);
                lineIndex++;
            }

            function removeLine(button) {
                const rows = document.querySelectorAll('.line-row');
                if (rows.length > 2) {
                    button.closest('tr').remove();
                    updateTotals();
                } else {
                    alert('A journal entry must have at least 2 lines.');
                }
            }

            function updateTotals() {
                let totalDebit = 0;
                let totalCredit = 0;

                document.querySelectorAll('.debit-input').forEach(input => {
                    totalDebit += parseFloat(input.value) || 0;
                });

                document.querySelectorAll('.credit-input').forEach(input => {
                    totalCredit += parseFloat(input.value) || 0;
                });

                document.getElementById('totalDebit').textContent = totalDebit.toFixed(2);
                document.getElementById('totalCredit').textContent = totalCredit.toFixed(2);

                const diff = Math.abs(totalDebit - totalCredit);
                const diffSpan = document.getElementById('difference');

                if (diff < 0.01) {
                    diffSpan.textContent = '0.00 (Balanced)';
                    diffSpan.className = 'badge bg-success';
                } else {
                    diffSpan.textContent = diff.toFixed(2) + ' (Unbalanced)';
                    diffSpan.className = 'badge bg-danger';
                }
            }

            document.addEventListener('DOMContentLoaded', updateTotals);
        </script>
    </div>
</body>
</html>